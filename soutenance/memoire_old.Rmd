---
title: "Performance comparison of the discrete choice models of consumer choice"
subtitle: "Exploration of the Econometrics and Machine Learning model performances in the presence of heterogeneous preferences and random effects utilities"
author: |
    | \large Nikita Gusarov
    | \normalsize Master 2
    | MIASHS C2ES (UGA)
    | 
    | \raggedright\small Under supervision of: 
    | \raggedright\hspace{10mm}\small Iragaël Joly, HDR (GAEL, UGA, Grenoble INP)
    | \raggedright\hspace{10mm}\small Beatrice Roussillon, MCF (GAEL, UGA)
    | \hspace{-40mm}
output: 
    beamer_presentation:
        # latex_engine: "lualatex"
        theme: "Montpellier"
        colortheme: "beaver"
        df_print: "kable"
        slide_level: 2
        fig_width: 4.2
        fig_height: 2.5
        fig_caption: TRUE
        includes:
            in_header: ../auxilary/header_memoire.tex
# Fonts as recommended in guidelines
# Works only with lualatex engine
# XITS is one of the analogs for proprietary Times New Roman
fontsize: 11pt 
# mainfont: XITS 
# linestretch: 1.15 # This is standard for Word Documents (MS Word 2007, 2010, 2016)
# Add autogenerated bibentry for r packages
bibliography: 
    - ../../litterature/bibliographie.bib 
    - ../../litterature/packages.bib
    - ../../litterature/supplementary/bibliographie.bib
biblio-style: ../../article/template/ecai2012
---





```{r Knitr, echo = FALSE}
#################
# Knitr options #
#################

knitr::opts_chunk$set(
    fig.align = "center",
    echo = FALSE,
    warning = FALSE
    # dev = "tikz"
)
```

```{r Packages, echo= FALSE, include = FALSE}
####################
# PAckages and AUX #
####################

# General document wide packages
library(tidyverse)
library(ggpubr)
```





# Introduction 

## General presentation

- The main differences in paradigms and interdisciplinarity
- Consumer choice modelling
- Idea of theory-testing framework 

## The main difference in paradigms 

\begin{figure}[hbtp]
\centering
\caption{The different paradigms}
\label{fig:parad}
\hspace{-32pt}\begin{subfigure}[c]{.4\linewidth}
    \centering
    \caption{Real world}
    \label{fig:parad1}
    \begin{tikzpicture}[box/.style = {draw, text width=2cm, align=center}]
        \node[box] (b) {Nature};
        \node[left=of b] (a) {$\mathcal{X}$};
        \node[right=of b] (c) {$\mathcal{Y}$};
        \draw[->] (a) -- (b);
        \draw[->] (b) -- (c);
    \end{tikzpicture}
\end{subfigure}\vspace{12pt}

\hspace{-52pt}\begin{subfigure}[c]{.3\linewidth}
    \centering
    \caption{Econometrics}
    \label{fig:parad2}
    \begin{tikzpicture}[box/.style = {draw, text width=2cm, align=center}]
        \node[box] (b) {Theoretical\\model};
        \node[left=of b] (a) {$X$};
        \node[right=of b] (c) {$Y$};
        \draw[->] (a) -- (b);
        \draw[->] (b) -- (c);
    \end{tikzpicture}
\end{subfigure}\hspace{52pt}
\begin{subfigure}[c]{.3\linewidth}
    \centering
    \caption{Machine Learning}
    \label{fig:parad3}
    \begin{tikzpicture}[box/.style = {draw, text width=2cm, align=center}]
        \node[box] (b) {Nature};
        \node[box, below=of b] (d) {ML\\model};
        \node[left=of b] (a) {$X$};
        \node[right=of b] (c) {$Y$};
        \draw[->] (a) -- (b);
        \draw[->] (b) -- (c);
        \draw[->] (a) |- (d);
        \draw[->] (d) -| (c);
    \end{tikzpicture}
\end{subfigure}\hspace{12pt}
\end{figure} 

## Consumer choice modelling [@mcfadden1974utd]

$$\{\omega_1, \dots, \omega_r \} \in \Omega$$

$$U_{ij} = V_{ij} + \eta_{ij}$$

$$V_{ij} = f(X_i, Z_j) + \eta_{ij}$$

$$f(X_i, Z_j) = \alpha_j + \beta_j X_i + \gamma Z_j$$

## Framework presentation

- Choice theories
- Datasets
- Models 
- Performance measures

## Illustration and context

- @llerena2013rose
- Heterogeneous and homogeneous effects 
- Experimental design 

## Experimental design 

\begin{table}[!htbp] \centering 
 \caption{Alternatives' attributes} 
 \label{tab:attributes} 
\begin{tabular}{@{\extracolsep{5pt}}lcccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
Statistic & \multicolumn{1}{c}{Levels} & \multicolumn{1}{c}{Min} & \multicolumn{1}{c}{Max} & \multicolumn{1}{c}{Step} \\ 
\hline \\[-1.8ex] 
Price & 7 & 1.5€ & 4.5€ & 0.5€\\ 
Label & 2 & 0 & 1 & 1 \\ 
Carbon & 2 & 0 & 1 & 1 \\
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

# Artificial dataset  

## Generation procedure 

- Utility function

\begin{multline}
V_{ij} = \alpha_{i,Buy} + \\
+ \beta_{Buy, Sex} Sex_i + \beta_{Buy, Age} Age_i + \beta_{Buy, Income} Income_i + \beta_{Buy, Habit} Habit_i + \\
+ \gamma_{Price} Price_{ij} + \gamma_{i, Label} Label_{ij} + \gamma_{i, Carbon} Carbon_{ij} + \\
+ \gamma_{i, Label \times Carbon} Label \times Carbon_{ij}
\end{multline}

$$LC_{ij} = Label \times Carbon_{ij}$$

- Input values 

## Dataset presentation 

- Descriptive stats 
- Present graphs for multiple datasets (as in "code/data_testing_memoire.R")
- Discuss statistical validity of the proposed procedure 
- Discuss how it may be improved and extended

## Descriptive statistics 

\tiny
\begin{table}[!htbp]\centering
    \caption{The assumed relative utility function parameters}
    \label{tab:params}
\begin{subfigure}[c]{.4\linewidth}
    \centering
    \caption{Mean effects}
    \label{tab:params1}
\begin{tabular}[b]{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
& \multicolumn{1}{c}{\textit{Effects}} \\ 
\cline{2-2} 
\\[-1.8ex] & \multicolumn{1}{c}{\textit{Means}} \\
\hline \\[-1.8ex] 
\textbf{Individual characteristics ($\beta$)} & \\
    ~~~Sex & 1.420 \\ 
    ~~~Age & 0.009 \\ 
    ~~~Salary & 0.057 \\ 
    ~~~Habit & 1.027 \\ 
\textbf{Alternatives' attributes ($\gamma$)} & \\
    ~~~Price & $-$1.631 \\ 
    ~~~Buy & 2.285 \\ 
    ~~~Label & 2.824 \\ 
    ~~~Carbon & 6.665 \\ 
    ~~~LC & $-$2.785 \\
    ~~~ & \\
\hline \\[-1.8ex] 
\end{tabular} 
\end{subfigure}
\hspace{1.5cm}
\begin{subfigure}[c]{.4\linewidth}
    \centering
    \caption{Variance-covariance}
    \label{tab:params2}
\begin{tabular}{@{\extracolsep{5pt}}lcc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Effects}} \\ 
\cline{2-3} 
\\[-1.8ex] & Fixed & Random \\ 
\hline \\[-1.8ex] 
\textbf{Variance} & & \\
    ~~~Buy & 0 & 3.202 \\  
    ~~~Label & 0 & 2.654 \\  
    ~~~Carbon & 0 & 3.535 \\  
    ~~~LC & 0 & 2.711 \\ 
\textbf{Covariance} & & \\ 
    ~~~Buy:Label & 0 & -0.54 \\  
    ~~~Buy:Carbon & 0 & -4.39 \\  
    ~~~Buy:LC & 0 & 6.17 \\  
    ~~~Label:Carbon & 0 & 8.77 \\  
    ~~~Label:LC & 0 & -2.33 \\  
    ~~~Carbon:LC & 0 & -4.82 \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{subfigure}
\end{table}
\normalsize

## Multiple datasets generation benchmark

```{r MultipleDatasets, cex = 0.5}
# Load dataset with bench
load("../../data/memoire/stat_novar.Rdata")
load("../../data/memoire/stat_covar.Rdata")

# Plot dataset
plot_stat = function(
    data = statistics, 
    type = "mean",
    variable = NULL) {
    data %>% 
    mutate(
        Type = as.factor(Type)
    ) %>% 
    dplyr::filter(
        Type == "mean",
        Alternative == "A"
    ) %>% 
    group_by(Individuals, Replications) %>%
    summarise_all(mean) %>%
    ggplot(
        aes(
            y = !!sym(variable), 
            # col = Replications,
            x = Individuals
        )) +
        stat_summary(
            geom = "ribbon", 
            fun.data = mean_sdl, 
            fill = "lightblue"
        ) +
        stat_summary(
            geom = "line", 
            fun = mean, 
            linetype = "dashed"
        ) +
        geom_point(
            size = 0.2
        ) + 
        scale_color_gradient(
            low = "blue", 
            high = "red"
        ) +
    theme_classic(base_size = 8)
}

# Sex
p_sex = plot_stat(stat_novar, "mean", "Sex")
# Habit
p_habit = plot_stat(stat_novar, "mean", "Habit")
# Salary
p_salary = plot_stat(stat_novar, "mean", "Salary")
# Age
p_age = plot_stat(stat_novar, "mean", "Age")

# Arrange plots
ggarrange(
    p_sex, p_habit, p_salary, p_age,
    ncol = 2, 
    nrow = 2,
    common.legend = TRUE, 
    legend = "right"
)
```

## Multiple datasets generation benchmark

```{r AlternativeSpec}
# Plot dataset
plot_stat = function(
    data = statistics, 
    type = "mean",
    variable = NULL) {
    data %>% 
    mutate(
        Type = as.factor(Type)
    ) %>% 
    dplyr::filter(
        Type == "mean",
        Alternative != "C"
    ) %>% 
    group_by(Replications, Run) %>%
    summarize_all(mean) %>% 
    ggplot(
        aes(
            y = !!sym(variable), 
            x = Replications
        )) +
        stat_summary(
            geom = "ribbon", 
            fun.data = mean_sdl, 
            fill = "lightblue"
        ) +
        stat_summary(
            geom = "line", 
            fun = mean, 
            linetype = "dashed"
        ) +
        geom_point(
            size = 0.2
        ) + 
        scale_color_gradient(
            low = "blue", 
            high = "red"
        ) +
    theme_classic(base_size = 8)
}

# Price 
p_price_novar = plot_stat(stat_novar, "mean", "Price") + ggtitle("Fixed effects")
p_price_covar = plot_stat(stat_covar, "mean", "Price") + ggtitle("Random effects")

# Arrange 
ggarrange(
    p_price_novar, p_price_covar, 
    ncol = 2,
    common.legend = TRUE, 
    legend = "bottom",
    align = "h"
)
```

## Alternative's utility 

```{r AlternativeUt}
# Plot dataset
plot_stat = function(
    data = statistics, 
    type = "mean",
    variable = NULL) {
    data %>% 
    mutate(
        Type = as.factor(Type)
    ) %>% 
    dplyr::filter(
        Type == "mean",
        Alternative != "C"
    ) %>% 
    group_by(Replications, Run) %>%
    summarize_all(mean) %>% 
    ggplot(
        aes(
            y = !!sym(variable), 
            x = Replications
        )) +
        stat_summary(
            geom = "ribbon", 
            fun.data = mean_sdl, 
            fill = "lightblue"
        ) +
        stat_summary(
            geom = "line", 
            fun = mean, 
            linetype = "dashed"
        ) +
        geom_point(
            size = 0.2
        ) + 
        scale_color_gradient(
            low = "blue", 
            high = "red"
        ) +
    theme_classic(base_size = 8)
}

# Alt Ut 
p_au_novar = plot_stat(stat_novar, "mean", "AU") + ggtitle("Fixed effects")
p_au_covar = plot_stat(stat_covar, "mean", "AU") + ggtitle("Random effects")

# Arrange 
ggarrange(
    p_au_novar, p_au_covar, 
    ncol = 2,
    common.legend = TRUE, 
    legend = "bottom",
    align = "h"
)
```

## Total utility 


```{r TotalUt}
# Plot dataset
plot_stat = function(
    data = statistics, 
    type = "mean",
    variable = NULL) {
    data %>% 
    mutate(
        Type = as.factor(Type)
    ) %>% 
    dplyr::filter(
        Type == "mean",
        Alternative != "C"
    ) %>% 
    group_by(Individuals, Replications) %>%
    summarize_all(mean) %>% 
    ggplot(
        aes(
            y = !!sym(variable), 
            x = Individuals
        )) +
        stat_summary(
            geom = "ribbon", 
            fun.data = mean_sdl, 
            fill = "lightblue"
        ) +
        stat_summary(
            geom = "line", 
            fun = mean, 
            linetype = "dashed"
        ) +
        geom_point(
            size = 0.2
        ) + 
        scale_color_gradient(
            low = "blue", 
            high = "red"
        ) +
    theme_classic(base_size = 8)
}

# Alt Ut 
p_tu_novar = plot_stat(stat_novar, "mean", "TU") + ggtitle("Fixed effects")
p_tu_covar = plot_stat(stat_covar, "mean", "TU") + ggtitle("Random effects")

# Arrange 
ggarrange(
    p_tu_novar, p_tu_covar, 
    ncol = 2,
    common.legend = TRUE, 
    legend = "bottom",
    align = "h"
)
```

# Modelling the consumer choices 

## Models presentation 

- Enumerate models 
- Find some simple way to describe them, without entering into detail 
- Discuss theoretical implications of each model (theoretical +/-)

## Models presentation 

- MNL 
- MMNL 
- CNN

## MNL 

$$P_{ij} = \frac{
    e^{\alpha_j + \beta_j X_i + \gamma Z_j}
}{
    \sum_{l = 1}^{k} e^{\alpha_l + \beta_l X_i + \gamma Z_l}
}$$

## MMNL 

$$P_{ij} = \frac{
    e^{\alpha_j + \beta_j X_i + (\gamma_i = \gamma + L \sigma_i) Z_j}
}{
    \sum_{l = 1}^{k} e^{\alpha_l + \beta_l X_i + (\gamma_i = \gamma + L \sigma_i) Z_l}
} \text{  where  } LL^T = V(\gamma_i) = \Sigma$$


## CNN

\small
\begin{figure}[!htbp] \centering 
 \caption{Convolution Neural Network design} 
 \label{fig:cnn} 
\hspace{-1cm}\begin{tikzpicture}[
    plain/.style={
        draw = none,
        fill = none,
    },
    net/.style={
        matrix of nodes,
        nodes={
            draw,
            circle,
            inner sep = 5pt
        },
        nodes in empty cells,
        column sep = 1cm,
        row sep = -9pt,
        ampersand replacement=\&
    },
    >=latex
]

\matrix[net] (mat)
{
    |[plain]| \parbox{0.5cm}{\centering Input\\layer} \& 
        |[plain]| \parbox{0.5cm}{\centering Convolution\\layer} \& 
        |[plain]| \parbox{0.5cm}{\centering Probability\\layer} \& 
        |[plain]| \parbox{0.5cm}{\centering Output\\layer} \\
    \& $V_A$ \& $P(A)$ \& |[plain]| \\
        |[plain]| \& |[plain]| \& |[plain]| \\
    \& $V_B$ \& $P(B)$ \& \\
        |[plain]| \& |[plain]| \& |[plain]| \\
    \& $V_C$ \& $P(C)$ \& |[plain]| \\
};


\draw[<-] (mat-2-1) -- node[above] {Rose A} +(-2.5cm,0);
\draw[<-] (mat-4-1) -- node[above] {Rose B} +(-2.5cm,0);
\draw[<-] (mat-6-1) -- node[above] {No buy (C)} +(-2.5cm,0);
\foreach \ai in {2,4,6}
    \draw[->] (mat-\ai-1) -- (mat-\ai-2);
\foreach \ai in {2,4,6}
    {\foreach \aii in {2,4,6}
        \draw[->] (mat-\ai-2) -- (mat-\aii-3);
    }
\foreach \ai in {2,4,6}
    \draw[->] (mat-\ai-3) -- (mat-4-4);
\draw[->] (mat-4-4) -- node[above] {Choice} +(2cm,0);

\end{tikzpicture}
\end{figure}
\normalsize

## Positive and negative elements in modelling approaches 

\small
\begin{table}[!htbp] \centering 
 \caption{Models' characteristics} 
 \label{tab:comb1} 
\begin{tabular}{@{\extracolsep{5pt}}lp{40mm}p{40mm}} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
Type & \multicolumn{1}{c}{Positive} & \multicolumn{1}{c}{Negative} \\ 
\hline \\[-1.8ex] 
MNL & 
    Easy to understand \newline Easy to implement \newline Most popular technique & 
    Produces fiable results only if all the hypothesis are verified \\
MMNL & 
    More flexible method \newline Accounts for tastes' heterogeneity & 
    Unefficient in computation \newline Requires more data \newline Not perfect estimates for variance \\
CNN & 
    Identical performances to MNL \newline May be fine-tuned \newline Ressources efficient & 
    Produces fiable results only if all the hypothesis are verified \\
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 
\normalsize

## Results presentation 

- Output the estimates 
- Compare them with target values 
- Discuss validity 

- It may be interesting to test multiple runs for models (over different datasets ?) ?

# Performance comparaison 

## General metrics 

- Present estimates
- Discuss 

## Single class metrics 

- Present metrics 
- Discuss the results 
- Not only "Buy" vs "No buy" but "A" and "B" vs all 
- Explain the differences 

## Case specific metrics 

- Present results 
- Think about a graph for presentation (boxplot-coefplot ? like default in R for coefs ?)
- Discuss observed results 

# Conclusion

## Summary 

- Repeat all that has been done (step by step)

## Opening and future work 

- Present the possible extentions 
- Offer something comprehensive for jury (see the interests and adjust)

## References 